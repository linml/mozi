<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>{{.title}}</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <!-- Theme style -->
    <!-- Select2 -->
    <link rel="stylesheet" href="/static/select2/dist/css/select2.min.css">
    <link rel="stylesheet" href="/static/css/AdminLTE.min.css">
    <link rel="stylesheet" href="/static/css/skins/_all-skins.min.css">
    <link href="/static/css/supershopui.common.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/zTree3/css/zTreeStyle/zTreeStyle.css" type="text/css">

    <style type="text/css">
        html {
            overflow: hidden;
        },
        bc{
            background: #000;
        }
    </style>
</head>
<body>
<div class="bc">
    <section class="content">
        <div>
            <div class="col-md-6">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">菜单管理</h3>
                    </div>
                    <form class="form-horizontal">
                        <div class="box-body">
                            <ul id="treeDemo" class="ztree"></ul>
                        </div>
                    </form>
                </div>

            </div>
            <div class="col-md-6">
                <div class="box box-info">
                    <div class="box-header with-border">
                        <h3 class="box-title">群组管理</h3>
                    </div>
                    <form class="form-horizontal">
                        <div class="box-body">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>选择群组</label>
                                    <div class="input-group">
                                        <select id="role" class="form-control select2" style="width: 100%;">
                                        </select>
                                        <span class="input-group-btn">
                                  <button type="button" onclick="query_role_menu()" class="btn btn-primary btn-flat">查询</button>
                                  <button type="button" class="btn btn-primary btn-flat">保存</button>
                                </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
        <!-- /.row -->

    </section>
</div>
<!-- Main content -->


<script src="/static/js/jquery.min.js"></script>
<script src="/static/layui/layui.js?s=36"></script>

<!-- Bootstrap 3.3.7 -->
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/supershopui.common.js"></script>
<script src="/static/js/bootbox.min.js"></script>
<script src="/static/zTree3/js/jquery.ztree.core.js"></script>
<script src="/static/zTree3/js/jquery.ztree.excheck.js"></script>
<script src="/static/zTree3/js/jquery.ztree.exedit.js"></script>
<!-- Select2 -->
<script src="/static/select2/dist/js/select2.full.min.js"></script>


<script>

    var zNodes = [{ id:1, pId:0, name:"数据错误"}];
    var checked = [];
    var setting = {
        check: {
            enable: true
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "pid"
            },
            key: {
                name: "text"
            },
            view: {
                showIcon: true,
            }
        }
    };


    $(function () {
        $('.select2').select2();
        refresh_role();

    });

    function query_role_menu() {
        var role_id = $('#role').val();
        refresh_tree(role_id)
    }
    function refresh_role() {
        $.ajax({
            type: "GET",
            url: "/role/list",
            data: {},
            dataType: 'json',
            success: function(rsp) {
                if(rsp.code==1){
                    var data = [];
                    for(var i=0;i<rsp.data.length;i++) {
                        data.push({id: rsp.data[i].id, text: rsp.data[i].name});
                    }
                    var $select = $('#role');
                    var instance;
                    instance = $select.data('select2');
                    if(instance){
                        $select.select2('destroy').empty();
                    }
                    $('#role').select2({
                        dropdownAutoWidth: true,
                        multiple: true,
                        data: data
                    });

                }
            }
        });
    }

    //加载树
    // refresh_tree();

    

    function refresh_tree(rid)
    {
        var time  = Date.parse(new Date());
        checked = [];

        $.ajax({
            type: "GET",
            url: "/role_menu/list",
            data: {role_id:Number(rid)},
            dataType: 'json',
            success: function(rsp) {
                if(rsp.code===1){
                    $.each(rsp.data,function(k,v){
                        // console.log(v)
                        checked.push(v.menu_id);
                    });
                }
            }
        });
        $.ajax({
            type: "GET",
            url: "/menu/node/list",
            data: {time:time},
            dataType: 'json',
            success: function(data) {
                if(data.code===1){
                    zNodes = init_checked(data.data);
                    zNodes = data.data;
                    $.fn.zTree.init($("#treeDemo"), setting, zNodes);
                }
            }
        });
        setCheck();
        $("#py").bind("change", setCheck);
        $("#sy").bind("change", setCheck);
        $("#pn").bind("change", setCheck);
        $("#sn").bind("change", setCheck);
    }

    function init_checked(zNodes) {
        $.each(zNodes,function(k,v){
            if($.inArray(v.id,checked)>=0){
                v.checked = true;
            }

        });
        return  zNodes;
    }

    function nodes_select_data(obj,nodes)
    {
        var nodes_str = '';
        $.each(obj,function(k,v){
            if(!v['name']) return nodes;
            node_id = v["id"]
            var i = 0;
            for (var j in nodes) { i++}
            nodes_str += v['id']+","
        });

        return nodes_str;
    }

    function setCheck() {
        type = { "Y" : "ps", "N" : "ps" };
        setting.check.chkboxType = type;
    }

    function showCode(str) {
        var code = $("#code");
        code.empty();
        for (var i=0, l=str.length; i<l; i++) {
            code.append("<li>"+str[i]+"</li>");
        }
    }

    function formSubmit() {


    }

    // });
</script>

</body>
</html>