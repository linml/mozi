<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>账户列表</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="/static/css/ionicons.min.css">
    <!-- iCheck for checkboxes and radio inputs -->
    <link rel="stylesheet" href="/static/plugins/iCheck/all.css">
    <!-- Bootstrap Color Picker -->
    <link rel="stylesheet" href="/static/css/bootstrap-colorpicker.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" href="/static/select2/dist/css/select2.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="/static/css/AdminLTE.min.css">

</head>

<div id="member_detail" aria-hidden="true" data-backdrop="static" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="box-header with-border">
                <h3 class="box-title">账户详情</h3>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>账户名</label>
                            <input type="text" class="form-control pull-right" id="detail_name" disabled>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>账户编号</label>
                            <input type="text" class="form-control pull-right" id="detail_user_id" disabled>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>上级编号</label>
                            <input type="text" class="form-control pull-right" id="detail_parent_id" disabled>
                        </div>
                    </div>
                </div>
                <div class="row">

                    <div class="col-md-4">
                        <div class="form-group">
                            <label>类型</label>
                            <div class="input-group">
                                <select id="detail_type" class="form-control select2" style="width: 100%;">
                                    <option value=0>代理</option>
                                    <option value=1>会员</option>
                                </select>
                                <span class="input-group-btn">
                                  <button type="button" class="btn btn-primary btn-flat">保存</button>
                                </span>
                            </div>

                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>状态</label>
                            <div class="input-group">
                                <select id="detail_status" class="form-control select2" style="width: 100%;">
                                    <option value=1>正常</option>
                                    <option value=0>冻结</option>
                                </select>
                                <span class="input-group-btn">
                                  <button type="button" class="btn btn-primary btn-flat">保存</button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>昵称</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="detail_nickname">
                                <span class="input-group-btn">
                                  <button type="button" class="btn btn-primary btn-flat">保存</button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>真实姓名</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="detail_real_name">
                                <span class="input-group-btn">
                                  <button type="button" class="btn btn-primary btn-flat">保存</button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>注册IP</label>
                            <input type="text" class="form-control pull-right" id="detail_register_ip" disabled>
                        </div>
                    </div>

                </div>


                <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>邮箱</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="detail_email">
                            <span class="input-group-btn">
                                  <button type="button" class="btn btn-primary btn-flat">保存</button>
                                </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>手机</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="detail_mobile">
                            <span class="input-group-btn">
                                  <button type="button" class="btn btn-primary btn-flat">保存</button>
                                </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>QQ</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="detail_qq">
                            <span class="input-group-btn">
                                  <button type="button" class="btn btn-primary btn-flat">保存</button>
                                </span>
                        </div>
                    </div>
                </div>
            </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>密码</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="detail_password">
                                <span class="input-group-btn">
                                  <button type="button" class="btn btn-primary btn-flat">保存</button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>资金密码</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="detail_money_password">
                                <span class="input-group-btn">
                                  <button type="button" class="btn btn-primary btn-flat">保存</button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label>权限</label>
                            <div class="row inline">
                                <div class="checkbox inline">
                                    <label>
                                        <input type="checkbox" id="power_login">
                                        登录
                                    </label>
                                </div>

                                <div class="checkbox inline">
                                    <label>
                                        <input type="checkbox" id="power_bet">
                                        游戏
                                    </label>
                                </div>

                                <div class="checkbox inline">
                                    <label>
                                        <input type="checkbox" id="power_deposit">
                                        充值
                                    </label>
                                </div>
                                <div class="checkbox inline">
                                    <label>
                                        <input type="checkbox" id="power_withdraw">
                                        提款
                                    </label>
                                </div>
                                <button type="button" class="btn btn-primary btn-flat">保存</button>
                            </div>
                        </div>


                    </div>

                </div>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="update_notice()">保存</button>
            </div>
        </div>
    </div>
</div>
<!-- /.modal -->

<div id="member_add" aria-hidden="true" data-backdrop="static" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="box-header with-border">
                <h3 class="box-title">新增账户</h3>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <label>上级模式选择</label>
                        <div class="row inline">
                            <select id="parent_type" class="form-control select2 inline" style="width: 20%;">
                                <option value=0>指定上级</option>
                                <option value=1>另开代理线</option>
                            </select>
                            <input type="text" class="form-control inline" id="add_parent_name" style="width: 25%;">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>账户名</label>
                            <input type="text" class="form-control" id="add_name" style="width: 100%;">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>密码</label>
                            <input type="text" class="form-control" id="add_password" style="width: 100%;">
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="add_member()">确认</button>
            </div>
        </div>
    </div>
</div>


<body class="hold-transition skin-blue sidebar-mini">

<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-xs-12">

            <div class="box">
                <input type="hidden" id="parent_id" name="extra" value="0">
                <div class="box-header">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="name">账户名</label>
                                <label class=" pull-right"><input type="checkbox">模糊查询</label>
                                <input type="text" class="form-control " id="name" placeholder="输入账户名">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="user_id">账户编号</label>
                                <input type="text" class="form-control " id="user_id" placeholder="账户编号">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="login_ip">登录IP</label>
                                <input type="text" class="form-control " id="login_ip" placeholder="登录IP">
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="form-group">
                                <label>状态</label>
                                <select id="status" class="form-control select2" style="width: 100%;">
                                    <option value="">全部</option>
                                    <option value=1>启用</option>
                                    <option value=0>禁用</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>操作</label>
                                <div class="row">
                                    <div class="btn-group">
                                        <button onclick="query_member()" type="button" class="btn btn-primary ">查询</button>
                                        <button onclick="query_reset()" type="button" class="btn btn-primary ">重置</button>
                                        <button type="button" class="btn btn-primary " data-toggle="modal" data-target="#member_add">新增</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box-body">
                    <table id="member" class="table table-bordered table-hover  table_style">
                        <thead>
                        <tr>
                            <th class="text-center">账户名</th>
                            <th class="text-center">余额</th>
                            <th class="text-center">类型</th>
                            <th class="text-center">状态</th>
                            <th class="text-center">创建时间</th>
                            <th class="text-center">最后登录时间</th>
                            <th class="text-center">最后登录IP</th>
                            <th class="text-center">操作</th>
                        </tr>
                        </thead>
                        <tbody id="member_data" class="text-center"></tbody>
                    </table>
                </div>

            </div>

        </div>
    </div>
    <!-- /.row -->
</section>
<!-- /.content -->



<!-- jQuery 3 -->
<script src="/static/js/jquery.min.js"></script>
<!--<script src="/js/jquery-3.2.1.js"></script>-->
<!-- Bootstrap 3.3.7 -->
<script src="/static/js/bootstrap.min.js"></script>
<!-- DataTables -->
<script src="/static/datatables.net/js/jquery.dataTables.js"></script>
<script src="/static/datatables.net-bs/js/dataTables.bootstrap.js"></script>

<!-- Select2 -->
<script src="/static/select2/dist/js/select2.full.min.js"></script>
<!-- SlimScroll -->
<script src="/static/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<!-- iCheck 1.0.1 -->
<script src="/static/plugins/iCheck/icheck.min.js"></script>
<!-- FastClick -->
<script src="/static/fastclick/lib/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="/static/js/adminlte.min.js"></script>
<script src="/static/ckeditor/ckeditor.js"></script>

<!-- page script -->
<script src="/static/laydate/laydate.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/js/sys_def.js"></script>
<script src="/static/js/bootbox.min.js"></script>
<script>
    $(function () {
        $('.select2').select2();

        var parent_type_select2 = $('#parent_type').select2();
        parent_type_select2.on("change", function (e) {
            var parent_type = $('#parent_type').val();
            if (parent_type === "0" ||parent_type === 0  ){
                $('#add_parent_name').val("");
                $('#add_parent_name').removeAttr("disabled");
            }else if (parent_type === "1" ||parent_type === 1  ){
                $('#add_parent_name').val("");
                $('#add_parent_name').attr("disabled","disabled");
            }modal-footer
        });

        $('input').iCheck({
            checkboxClass: 'icheckbox_square-blue',
            radioClass: 'iradio_square-blue',
            increaseArea: '20%' // optional
        });

        $('#member_detail').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget) // Button that triggered the modal
            var user_id = button.data('user_id');
            var params = {};
            params.user_id = user_id;
            $.get('/member/infos', params, function (rs) {
                if (rs.code === SYS_DEF.CODE.SUCCESS) {
                    var modal = $(this);
                    $('#detail_user_id').val(rs.data.user_id);
                    $('#detail_name').val(rs.data.name);
                    $('#detail_status').val(rs.data.status).trigger("change");
                    $('#detail_status').change();
                }else{
                    bootbox.alert(rs.msg)
                }
            });
            $.get('/member/profile', params, function (rs) {
                if (rs.code === SYS_DEF.CODE.SUCCESS) {
                    var modal = $(this);
                    $('#detail_qq').val(rs.data.qq);
                    $('#detail_mobile').val(rs.data.mobile);
                    $('#detail_email').val(rs.data.email);
                    $('#detail_nickname').val(rs.data.nickname);
                    $('#detail_real_name').val(rs.data.real_name);
                    $('#detail_register_ip').val(rs.data.register_ip);
                }else{
                    bootbox.alert(rs.msg)
                }
            });
            $.get('/member/relation', params, function (rs) {
                if (rs.code === SYS_DEF.CODE.SUCCESS) {
                    var modal = $(this);
                    $('#detail_parent_id').val(rs.data.parent_id);
                    $('#detail_type').val(rs.data.user_type).trigger("change");
                    $('#detail_type').change();
                }else{
                    bootbox.alert(rs.msg)
                }
            });
            $.get('/member/power', params, function (rs) {
                if (rs.code === SYS_DEF.CODE.SUCCESS) {
                    var modal = $(this);
                    if (rs.data.power_bet === 1){
                        $('#power_bet').iCheck("check");
                    }else{
                        $('#power_bet').iCheck("uncheck");
                    }
                    if (rs.data.power_login === 1){
                        $('#power_login').iCheck("check");
                    }else{
                        $('#power_login').iCheck("uncheck");
                    }
                    if (rs.data.power_deposit === 1){
                        $('#power_deposit').iCheck("check");
                    }else{
                        $('#power_deposit').iCheck("uncheck");
                    }
                    if (rs.data.power_withdraw === 1){
                        $('#power_withdraw').iCheck("check");
                    }else{
                        $('#power_withdraw').iCheck("uncheck");
                    }


                }else{
                    bootbox.alert(rs.msg)
                }
            })
        });
        $('#member_add').on('show.bs.modal', function (event) {
            $('#parent_type').val("0").trigger("change");
            $('#parent_type').change();
        });
    })
</script>
<script>
    var myTable;
    myTable = $("#member").DataTable({
        language: datatable_lang,  //提示信息
        autoWidth: false,  //禁用自动调整列宽
        stripeClasses: ["odd", "even"],  //为奇偶行加上样式，兼容不支持CSS伪类的场合
        // processing: true,  //隐藏加载提示,自行处理
        serverSide: true,  //启用服务器端分页，即开启后端分页
        searching: false,  //禁用原生搜索
        lengthChange: false,
        // destroy: true,
        ordering: false,
        order: [],  //取消默认排序查询,否则复选框一列会出现小箭头
        columns: [
            {"data": "name"},
            {"data": "balance"},
            {"data": "is_test"},
            {"data": "status"},
            {"data": "registered"},
            {"data": "last_login_at"},
            {"data": "last_login_ip"},
            {"data": null}
        ],
        columnDefs: [
            {
                "render": function(data, type, row, meta) {
                    if (row.user_type === 0){
                        return '代理';
                    }
                    return '<p class="text-red">会员</p>';
                },
                "targets": 2
            },
            {
                "render": function(data, type, row, meta) {
                    if (row.status === 1){
                        return '启用';
                    }
                    return '<p class="text-red">禁用</p>';
                },
                "targets": 3
            }, {
                "render": function(data, type, row, meta) {
                    return format_time(row.registered);
                },
                "targets": 4
            },{
                "render": function(data, type, row, meta) {
                    return format_time(row.last_login_at);
                },
                "targets": 5
            },{
                "render": function(data, type, row, meta) {
                    var html_str = '<div class="btn-group"><button class="btn btn-primary btn-xs" data-toggle="modal" data-target="#member_detail" data-user_id="'+row.user_id +'">详情</i></button>';
                    if (row.parent_id === 0 || row.parent_id === "0"){

                    }else {
                        html_str += '<button onclick="uper_member('+ row.parent_id+')" class="btn btn-primary btn-xs">上级</i></button>'
                    }

                    html_str += '<button onclick="lower_member('+ row.user_id+')" class="btn btn-primary btn-xs">下级</i></button>' +
                            '<button onclick="del_notice(\'+ row.id+\')" class="btn btn-danger btn-xs">禁用</i></button></div>';
                    return html_str


                },
                "targets": 7
            }
        ],
        ajax:function(data, callback, settings){
            var param = {};
            //其他的参数
            param.page_row = data.length;//页面显示记录条数，在页面显示每页显示多少项的时候
            // param.start = data.start;//开始的记录序号
            param.curr_page = (data.start / data.length)+1;//当前页码
            param.draw = data.draw+1;//当前页码

            param.parent_id = $('#parent_id').val();

            if ($('#user_id').val() !== ""){
                param.user_id = $('#user_id').val();
                delete param.parent_id
            }
            if ($('#name').val() !== ""){
                param.name = $('#name').val();
                delete param.parent_id
            }
            if ($('#login_ip').val() !== ""){
                param.login_ip = $('#login_ip').val();
            }
            if ($('#status').val() !== ""){
                param.status = $('#status').val();
            }
            if ($('#is_test').val() !== ""){
                param.is_test = $('#is_test').val();
            }



            var url = "/pages/user/list";

            $.ajax({
                type: "GET",
                url: url,
                data: param,    //传入已封装的参数
                dataType: "json",
                success: function(result) {
                    //setTimeout仅为测试延迟效果
                    setTimeout(function(){
                        //异常判断与处理
                        if (result.code !== SYS_DEF.CODE.SUCCESS) {
                            bootbox.alert("查询失败。错误码："+result.code);
                            return;
                        }
                        $("#member_data tr").remove();

                        //封装返回数据，这里仅演示了修改属性名
                        var returnData = {};
                        returnData.draw = result.data.draw;//这里直接自行返回了draw计数器,应该由后台返回
                        returnData.recordsTotal = result.data.total_count;
                        returnData.recordsFiltered = result.data.total_count;//后台不实现过滤功能，每次查询均视作全部结果
                        if (result.data.record_data === null){
                            returnData.data = []
                        }else {
                            returnData.data = result.data.record_data;
                        }

                        if (result.data.total_count > 0){
                            callback(returnData);
                        }else {
                            TableDataIsNull('member_data');
                        }

                    },200);
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    bootbox.alert("查询失败");
                }
            });
        },
    });

    function query_member() {
        myTable.ajax.reload();
    }
    function query_reset() {
        $('#parent_id').val(0);
        $('#user_id').val("");
        $('#name').val("");
        $('#login_ip').val("");
        $('#status').val("").trigger("change");
        $('#status').change();
        $('#is_test').val("").trigger("change");
        $('#is_test').change();

        myTable.ajax.reload();
    }

    function lower_member(parent_id) {
        $('#name').val("");
        $('#user_id').val("");
        $('#parent_id').val(parent_id);
        myTable.ajax.reload();
    }

    function uper_member(user_id) {
        $('#name').val("");
        $('#parent_id').val("");
        $('#user_id').val(user_id);
        myTable.ajax.reload();
    }

    function add_member() {
        var parent_type = $('#parent_type').val();
        var parent_name = $('#add_parent_name').val();
        var params = {};
        if (parent_type === "1"|| parent_type === 1){
            params.is_new_line = 1;
        }else {
            params.is_new_line = 0;
            params.parent_name = parent_name;
        }
        params.name = $('#add_name').val();
        params.password = $('#add_password').val();
        $.post('/member/add', params, function (rs) {
            if (rs.code === SYS_DEF.CODE.SUCCESS) {
                bootbox.alert(rs.msg|| "添加成功");
            }else{
                bootbox.alert(rs.msg)
            }
        })


    }

</script>

</body>
</html>
